# Redis 接口流程图

## 1. 点赞系统缓存流程

### 1.1 点赞/取消点赞流程

```
用户发起点赞/取消点赞请求
           │
           ▼
┌──────────────────────────┐
│  检查 Redis 中是否已存在  │
│     用户点赞记录          │
│  CheckVideoLikeExists()  │
│  CheckCommentLikeExists()│
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│     防止重复操作检查      │
│  点赞时：已存在则返回错误  │
│  取消时：不存在则返回错误  │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   更新 Redis 缓存数据     │
│  1. IncrVideoLikeCount() │
│     更新点赞计数          │
│  2. SetVideoLike() /     │
│     DelVideoLike()       │
│     记录/删除用户点赞关系  │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   异步发送 Kafka 消息     │
│   (持久化到 MySQL)       │
└──────────────────────────┘
           │
           ▼
       请求完成
```

## 2. 聊天消息缓存流程

### 2.1 发送私聊消息流程

```
用户发送私聊消息
           │
           ▼
┌──────────────────────────┐
│   生成消息唯一 ID         │
│  {fromID}_{toID}_{时间戳} │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   Redis Pipeline 操作    │
│  1. HSET 存储消息详情     │
│     - id, from_user_id   │
│     - to_user_id, content│
│     - created_at         │
│  2. EXPIRE 设置过期时间   │
│  3. ZADD 添加到用户消息   │
│     列表（按时间排序）    │
│  4. ZREMRANGEBYRANK     │
│     限制列表大小          │
│  5. LPUSH 添加到同步队列  │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   后台 SyncWorker        │
│   定时批量同步到 MySQL    │
└──────────────────────────┘
           │
           ▼
       消息发送完成
```

### 2.2 获取私聊历史消息流程

```
用户请求历史消息
           │
           ▼
┌──────────────────────────┐
│  尝试从 Redis 获取消息    │
│  GetPrivateMessages()    │
│  ZREVRANGE 按时间倒序获取 │
└──────────────────────────┘
           │
           ▼
      ┌────┴────┐
      │ 缓存命中? │
      └────┬────┘
     是    │    否
   ┌───────┴───────┐
   ▼               ▼
┌──────┐    ┌──────────────┐
│ 返回  │    │ 从 MySQL 查询 │
│ 缓存  │    │ 历史消息      │
└──────┘    └──────────────┘
```

### 2.3 发送群聊消息流程

```
用户发送群聊消息
           │
           ▼
┌──────────────────────────┐
│   生成消息唯一 ID         │
│  {groupID}_{fromID}_{ts} │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   Redis Pipeline 操作    │
│  1. HSET 存储消息详情     │
│  2. EXPIRE 设置过期时间   │
│  3. ZADD 添加到群消息列表 │
│  4. LPUSH 添加到同步队列  │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   后台 SyncWorker        │
│   定时批量同步到 MySQL    │
└──────────────────────────┘
           │
           ▼
       消息发送完成
```

### 2.4 消息同步工作器（SyncWorker）流程

```
SyncWorker 定时触发（每5秒）
           │
           ▼
┌──────────────────────────┐
│  LRANGE 批量获取待同步    │
│  消息 ID（最多200条）     │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  Pipeline 批量获取消息详情│
│  HGETALL 每条消息        │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  解析消息数据并组装       │
│  数据库模型               │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  批量写入 MySQL          │
│  BatchCreateMessages()   │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  LREM 从队列移除已处理    │
│  的消息 ID               │
└──────────────────────────┘
           │
           ▼
       同步完成
```

## 3. MFA 缓存流程

### 3.1 获取 MFA 二维码流程

```
用户请求绑定 MFA
           │
           ▼
┌──────────────────────────┐
│  查询用户信息             │
│  QueryUserByID()         │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  生成 TOTP 密钥          │
│  GenerateTotp()          │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  生成二维码图片           │
│  转换为 Base64           │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  加密 TOTP Secret        │
│  Encrypt(secret)         │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  存入 Redis（15分钟过期） │
│  SetTOTPSecret()         │
│  Key: totp_secret:{uid}  │
└──────────────────────────┘
           │
           ▼
  返回 Secret 和二维码
```

### 3.2 绑定 MFA 流程

```
用户提交验证码绑定 MFA
           │
           ▼
┌──────────────────────────┐
│  从 Redis 获取临时 Secret│
│  GetTOTPSecret()         │
└──────────────────────────┘
           │
           ▼
      ┌────┴────┐
      │ 存在?    │
      └────┬────┘
     是    │    否
   ┌───────┴───────────────┐
   │                       ▼
   │               ┌────────────┐
   │               │返回错误：    │
   │               │未获取二维码 │
   │               └────────────┘
   ▼
┌──────────────────────────┐
│  解密并验证 Secret       │
│  Decrypt() + 比对        │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  验证用户输入的验证码     │
│  CheckTotp(code, secret) │
└──────────────────────────┘
           │
           ▼
      ┌────┴────┐
      │ 验证通过? │
      └────┬────┘
     是    │    否
   ┌───────┴───────────────┐
   │                       ▼
   │               ┌────────────┐
   │               │返回错误：    │
   │               │验证码无效   │
   │               └────────────┘
   ▼
┌──────────────────────────┐
│  更新数据库 MFA 字段      │
│  UpdateMFA()             │
└──────────────────────────┘
           │
           ▼
      绑定成功
```

### 3.3 登录时 MFA 验证流程

```
用户登录
           │
           ▼
┌──────────────────────────┐
│  验证用户名密码           │
└──────────────────────────┘
           │
           ▼
      ┌────┴────┐
      │用户已绑定 │
      │ MFA?     │
      └────┬────┘
     是    │    否
   ┌───────┴────────┐
   │                ▼
   │          登录成功
   ▼
┌──────────────────────────┐
│  验证用户提交的 MFA 码    │
│  CheckTotp(code, TOTP)   │
└──────────────────────────┘
           │
           ▼
      ┌────┴────┐
      │ 验证通过? │
      └────┬────┘
     是    │    否
   ┌───────┴───────────────┐
   │                       ▼
   │               ┌────────────┐
   │               │返回错误：    │
   │               │MFA 验证失败 │
   │               └────────────┘
   ▼
    登录成功
```
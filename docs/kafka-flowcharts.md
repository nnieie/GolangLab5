# 消息队列（Kafka）接口流程图

本文档描述了项目中所有使用 Kafka 消息队列的接口的运作原理。

---

## 1. 点赞事件消息队列流程

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      点赞服务 (Interaction)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1. 更新 Redis 缓存
                              │ 2. 发送点赞事件
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         Kafka                               │
│              Topic: interaction-events                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 消费消息
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    批量处理器 (BatchProcessor)               │
│         缓冲区大小: 100 条 | 刷新间隔: 5 秒                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 批量写入
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         MySQL                               │
│                    likes 表持久化                            │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 点赞事件生产流程

```
用户点赞/取消点赞操作
           │
           ▼
┌──────────────────────────┐
│   检查 Redis 点赞状态     │
│   防止重复操作            │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   更新 Redis 缓存         │
│   - 点赞计数 +1/-1        │
│   - 用户点赞关系记录       │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│   构建 LikeEvent 事件     │
│   - EventID: 唯一标识     │
│   - EventType: Like       │
│   - Timestamp: 时间戳     │
│   - UserID: 用户 ID       │
│   - VideoID/CommentID     │
│   - Action: 1点赞/2取消   │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  异步发送到 Kafka         │
│  (goroutine 不阻塞主流程) │
│  PublishLikeEvent()      │
└──────────────────────────┘
           │
           ▼
   返回成功（不等待持久化）
```

### 1.3 点赞事件消费流程

```
┌──────────────────────────┐
│  Kafka Consumer 启动     │
│  GroupID: like-          │
│  persistence-group       │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  消费 LikeEvent 消息      │
│  ConsumeLikeEvents()     │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  添加到 BatchProcessor   │
│  缓冲区                   │
│  AddEvent(event)         │
└──────────────────────────┘
           │
           ▼
      ┌────┴────────────────┐
      │  触发刷新条件?       │
      │  - 缓冲区满100条     │
      │  - 定时器5秒到期     │
      └────┬────────────────┘
           │
           ▼
┌──────────────────────────┐
│  复制缓冲区数据           │
│  快速释放锁               │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  分组处理                 │
│  - likesToInsert: 点赞   │
│  - likesToDelete: 取消   │
└──────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│  批量写入 MySQL           │
│  - BatchLikeAction()     │
│  - BatchUnlikeAction()   │
└──────────────────────────┘
           │
           ▼
       处理完成
```

### 1.4 批量处理器工作原理

```
        ┌─────────────────────────────────────────┐
        │           BatchProcessor                │
        │                                         │
        │  ┌─────────────────────────────────┐    │
        │  │        缓冲区 (buffer)           │   │
        │  │   [event1, event2, ..., eventN] │   │
        │  │      容量: 100                   │   │
        │  └─────────────────────────────────┘   │
        │                                        │
        │  ┌─────────────┐    ┌─────────────┐    │
        │  │ 定时器       │    │  满载触发    │   │
        │  │ 5秒/次      │    │  100条触发   │    │
        │  └──────┬──────┘    └──────┬──────┘    │
        │         │                   │          │
        │         └───────┬───────────┘          │
        │                 ▼                      │
        │         ┌─────────────┐                │
        │         │   Flush()   │                │
        │         │   批量刷新   │                │
        │         └─────────────┘                │
        └────────────────────────────────────────┘
```